# Critical Bug Fixes - November 6, 2025

## Summary

Fixed **3 critical false positive bugs** in synergy detection that were causing incorrect synergies to be reported.

---

## Bug #1: Token Synergy Detecting Opponent Tokens âŒ â†’ âœ…

### Problem
**Generous Gift** was incorrectly detected as creating tokens for your token synergies.

**Card text**: "Destroy target permanent. Its controller creates a 3/3 green Elephant creature token."

The token goes to your **OPPONENT**, not you, yet the system detected:
```
âœ— "Generous Gift creates tokens, Red XIII pumps them for lethal"
```

### Root Cause
```python
# OLD CODE (INCORRECT)
token_patterns = [
    r'create.*token',  # âŒ Matches ANY token creation
]

card1_makes_tokens = any(re.search(pattern, card1_text) for pattern in token_patterns)
```

The pattern matched "creates a 3/3 green Elephant creature token" without checking WHO gets the token.

### Fix Applied
```python
# NEW CODE (CORRECT)
# Patterns that indicate tokens go to OPPONENT (exclude these)
opponent_token_patterns = [
    r'opponent.*creates?.*token',
    r'target opponent.*creates?',
    r'its controller creates?.*token',      # âœ… FIXES Generous Gift
    r'defending player creates?.*token',
    r'each opponent creates?.*token'
]

# Check if card makes tokens AND they're YOUR tokens
card1_makes_tokens = any(re.search(pattern, card1_text) for pattern in token_patterns) and \
                     not any(re.search(pattern, card1_text) for pattern in opponent_token_patterns)
```

### Test Result
- âœ… **Generous Gift** â†’ No longer creates false token synergies
- âœ… **Krenko, Mob Boss** â†’ Still correctly detects token creation
- âœ… **Forbidden Orchard** â†’ Correctly excluded (opponent gets tokens)

---

## Bug #2: Cheat Detection Matching Ramp Spells âŒ â†’ âœ…

### Problem
**Cultivate** was incorrectly detected as "cheating spells into play"

**Card text**: "Search your library for up to two basic land cards, reveal those cards, put one onto the battlefield tapped and the other into your hand"

System detected:
```
âœ— "Cultivate cheats Vanquish the Horde (CMC 8.0) into play"
```

Cultivate is **RAMP**, not a cheat effect!

### Root Cause
```python
# OLD CODE (INCORRECT)
cheat_patterns = [
    r'without paying.*mana cost',
    r'put.*onto the battlefield',  # âŒ TOO BROAD - matches land ramp!
]

card1_cheats = any(re.search(pattern, card1_text) for pattern in cheat_patterns)
```

The pattern `r'put.*onto the battlefield'` matched Cultivate's text because it puts **lands** onto the battlefield.

### Fix Applied
```python
# NEW CODE (CORRECT)
cheat_patterns = [
    r'without paying.*mana cost',
    r'put.*creature.*onto the battlefield',   # âœ… Specific to creatures
    r'put.*artifact.*onto the battlefield',   # âœ… Specific to artifacts
    r'put.*enchantment.*onto the battlefield',# âœ… Specific to enchantments
]

# Explicitly exclude land ramp (NOT cheat effects)
ramp_patterns = [
    r'search.*library.*land',
    r'put.*land.*onto the battlefield',       # âœ… EXCLUDES Cultivate
    r'basic land.*onto the battlefield',
]

card1_cheats = any(re.search(pattern, card1_text) for pattern in cheat_patterns) and \
               not any(re.search(pattern, card1_text) for pattern in ramp_patterns)
```

### Test Result
- âœ… **Cultivate** â†’ No longer creates false cheat synergies
- âœ… **Kodama's Reach** â†’ Correctly excluded (ramp, not cheat)
- âœ… **Animate Dead** â†’ Still correctly detects cheating creatures
- âœ… **Sneak Attack** â†’ Still correctly detects cheating creatures

---

## Bug #3: Spellslinger Detection Matching Aura/Equipment Triggers âŒ â†’ âœ…

### Problem
**Sram, Senior Edificer** was incorrectly detected as triggering on ALL spells

**Sram text**: "Whenever you cast an Aura, Equipment, or Vehicle spell, draw a card."

System detected:
```
âœ— "Sram triggers on spells, Vandalblast (CMC 1.0) fuels it"
```

**Vandalblast** is a Sorcery, NOT an Aura/Equipment/Vehicle!

### Root Cause
```python
# OLD CODE (INCORRECT)
spell_trigger_patterns = [
    r'whenever you cast.*spell'  # âŒ TOO BROAD - matches "Aura...spell"
]

card1_has_trigger = any(re.search(pattern, card1_text) for pattern in spell_trigger_patterns)
```

The pattern `r'whenever you cast.*spell'` matched "Whenever you cast an Aura, Equipment, or Vehicle **spell**"

### Fix Applied
```python
# NEW CODE (CORRECT)
# Distinguish Aura/Equipment triggers from general spell triggers
aura_equipment_patterns = [
    r'whenever you cast an aura',
    r'whenever you cast an equipment',
    r'whenever you cast a vehicle',
    r'whenever you cast an aura, equipment, or vehicle'  # âœ… EXCLUDES Sram
]

# Exclude Aura/Equipment triggers from spellslinger detection
card1_is_aura_equipment_trigger = any(re.search(pattern, card1_text) for pattern in aura_equipment_patterns)

card1_has_trigger = (any(re.search(pattern, card1_text) for pattern in spell_trigger_patterns) or \
                    any(re.search(pattern, card1_text) for pattern in magecraft_patterns) or \
                    'prowess' in card1_keywords) and \
                    not card1_is_aura_equipment_trigger  # âœ… FIXED
```

### Test Result
- âœ… **Sram** + **Vandalblast** â†’ No longer creates false synergy
- âœ… **Sram** + **Sigarda's Aid** (Enchantment - Aura) â†’ Would still correctly synergize (if both were in deck)
- âœ… **Storm-Kiln Artist** (actual spellslinger) + **Vandalblast** â†’ Still correctly detects synergy

---

## Additional Issues Identified (Not Yet Fixed)

### 4. Generic Death Trigger Matching

**Example false positive:**
```
âœ— "Vincent, Vengeful Atoner and Professor Hojo both trigger when creatures die"
```

**Problem**: Just because two cards both have death triggers doesn't mean they synergize. They need to **interact** with each other.

**Requires investigation**: Need to check death trigger detection logic.

---

## Impact Summary

| Bug | Cards Affected | Severity | Status |
|-----|----------------|----------|--------|
| **#1: Opponent Tokens** | Generous Gift, Forbidden Orchard, etc. | ğŸ”´ Critical | âœ… Fixed |
| **#2: Ramp as Cheat** | Cultivate, Kodama's Reach, Rampant Growth, etc. | ğŸ”´ Critical | âœ… Fixed |
| **#3: Aura/Equipment Triggers** | Sram, Jhoira, Weatherlight Captain, etc. | ğŸ”´ Critical | âœ… Fixed |
| **#4: Generic Death Triggers** | Various death trigger cards | ğŸŸ  High | â³ Needs investigation |

---

## Testing Recommendations

### Manual Test Cases

Run the following test pairs through the system to verify fixes:

**Test #1: Opponent Tokens**
- âŒ Generous Gift + Any anthem effect â†’ Should NOT synergize
- âœ… Krenko, Mob Boss + Impact Tremors â†’ Should synergize
- âŒ Forbidden Orchard + Intangible Virtue â†’ Should NOT synergize

**Test #2: Ramp vs Cheat**
- âŒ Cultivate + Ulamog, the Infinite Gyre â†’ Should NOT show "cheat" synergy (ramp synergy OK)
- âœ… Animate Dead + Ulamog â†’ Should synergize (actual cheat)
- âŒ Rampant Growth + Expropriate â†’ Should NOT show "cheat" synergy

**Test #3: Aura/Equipment Triggers**
- âŒ Sram + Vandalblast â†’ Should NOT synergize
- âœ… Sram + All That Glitters (Aura) â†’ Should synergize
- âœ… Storm-Kiln Artist + Vandalblast â†’ Should synergize (actual spellslinger)

---

## Files Modified

- `/src/synergy_engine/rules.py`
  - `detect_token_anthems()` - Lines 1410-1447
  - `detect_cheat_big_spells()` - Lines 1148-1183
  - `detect_spellslinger_payoffs()` - Lines 1703-1758

---

## Next Steps

1. âœ… **Fixed critical bugs** (Bugs #1-3)
2. â³ **Investigate death trigger detection** (Bug #4)
3. â³ **Run full test suite** with problem cards
4. â³ **Create regression tests** to prevent re-introduction
5. â³ **Audit other detection functions** for similar issues

---

## Acknowledgments

These bugs were identified through user testing with real decks. Thank you to the user for providing specific examples that exposed these critical flaws in the synergy detection system.

**Key Learning**: Regex patterns must be **specific** and **contextual**. Always check for exclusions (opponent tokens, land ramp, specific trigger types) to avoid false positives.
